name: Deploy Library Backend
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies & restart app
      run: |
        echo "🚀 Deployment started at $(date)"
        
        # Debug info
        echo "=== SYSTEM INFO ==="
        node -v
        npm -v
        pm2 -v
        echo "=================="
        
        # Project directory
        TARGET_DIR="/home/githubrunner/actions-runner/_work/library_project/library_project"
        echo "Target directory: $TARGET_DIR"
        
        if [ ! -d "$TARGET_DIR" ]; then
          echo "❌ Papka topilmadi: $TARGET_DIR"
          exit 1
        fi
        
        cd "$TARGET_DIR" || exit 1
        
        # Cleanup
        echo "🧹 Eski fayllarni tozalash..."
        sudo rm -rf node_modules package-lock.json .npmrc
        
        # Install with debug
        echo "📦 Paketlarni o'rnatish..."
        npm install --loglevel verbose --unsafe-perm 2>&1 | tee npm-debug.log
        
        # PM2 process
        echo "🔄 PM2 ni qayta ishga tushirish..."
        pm2 delete library || true
        pm2 start index.js --name library
        
        echo "✅ Deployment finished at $(date)"
        
        # Debug log
        echo "=== INSTALLATION LOG ==="
        cat npm-debug.log | tail -n 20
        echo "======================="